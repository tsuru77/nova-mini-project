services:
  ryu:
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile.ryu
    container_name: ryu-controller
    ports:
      - "8080:8080"  # REST API
      - "6633:6633"  # OpenFlow
    networks:
      - sdn-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -s -o /dev/null -w '%{http_code}' http://localhost:8080 || exit 0"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 20s

  mininet:
    platform: linux/amd64
    image: iwaseyusuke/mininet:latest
    container_name: mininet-topo
    privileged: true
    volumes:
      - ./topology:/mininet/topology:ro
      - ./scripts:/mininet/scripts:ro
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
    stdin_open: true
    tty: true
    depends_on:
      ryu:
        condition: service_healthy
    networks:
      - sdn-network
    # Utiliser le réseau Docker au lieu de host mode pour compatibilité macOS
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: /bin/bash -c "sleep 2 && /bin/bash"

networks:
  sdn-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

